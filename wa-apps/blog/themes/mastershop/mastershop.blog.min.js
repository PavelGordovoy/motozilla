$(function(){$.blog_utils.highlight("#post-stream");var e=function(e,i,s){t(),$(".comment-form").find("input[name=parent]").val(i);var a=$(".comment-form").show().insertAfter(e).find("[name=text]").val("");s&&a.focus()},t=function(e){var t=$(".comment-form");t.find(".errormsg").remove(),t.find(".error").removeClass("error"),t.find(".wa-captcha-refresh").click(),e&&t.find("textarea").val("")};$(".comment-reply").live("click",function(){var t=$(this).parents(".comment"),i=t.length?parseInt($(t).attr("id").replace(/^[\D]+/,"")):0;return e($(this).parent(),i,!1),$(".comment").removeClass("in-reply-to"),t.addClass("in-reply-to"),!1}),$(".js-add-comment-btn").on("click",function(){return e(".comments",0),!1}),$(".comment-form input:submit").click(function(){var i=$(this);i.attr("disabled",!0).next().removeClass("display-none");var s=$(".comment-form"),a=$(".comment-form form");return $.post(a.attr("action")+"?json=1",a.serialize(),function(a){if(i.attr("disabled",!1).next().addClass("display-none"),a.status&&"ok"==a.status&&a.data.redirect)return window.location.replace(a.data.redirect),void(window.location.href=a.data.redirect);if(a.status&&"ok"==a.status&&a.data){var o,r=$(a.data.template),n=a.data.count_str;s.prev().is(".comments")?o=s.prev(".comments").children("ul"):(o=s.parent(),o.next("ul").size()||o.after("<ul></ul>"),o=o.next("ul")),o.append($("<li />").append(r)),e(".comments",0),a.data.comment_id&&$("#comment-"+a.data.comment_id).addClass("new"),$(".not-comment").remove(),$(".comment").removeClass("in-reply-to"),$(".comment-count").show().html(n),r.trigger("plugin.comment_add"),t(!0)}else if(a.status&&"fail"==a.status){t();var l=a.errors;$(l).each(function(e){var t=this;for(name in t){$(".comment-form form").find("[name="+name+"]").after($('<em class="errormsg"></em>').text(t[name])).addClass("error")}})}else t(!1)},"json").error(function(){t(!1)}),!1});var i="guest",s=$("ul#user-auth-provider li.selected");s.length?i=s.attr("data-provider")||i:(s=$("#user-auth-provider, .js-user-auth-provider"),s.length&&(i=s.attr("data-provider")||i)),i&&($(".tab").hide(),"signup"==i?$(".comment-submit, .comment-body").hide():$(".comment-submit, .comment-body").show(),$("div.tab[data-provider='"+i+"']").show(),$("input[name=auth_provider]").val(i),"guest"==i?$(".wa-captcha").show():$(".wa-captcha").hide()),$("ul#user-auth-provider li.selected a, ul#user-auth-provider li:eq(0) a").click(function(){if($(this).parent().hasClass("selected"))return!1;var e=$(this).parent().attr("data-provider");return $(this).parent().addClass("selected").siblings().removeClass("selected"),$(".tab").hide(),$("div.tab[data-provider='"+e+"']").show(),"guest"==e?$(".wa-captcha").show():$(".wa-captcha").hide(),"signup"==e?$(".comment-submit, .comment-body").hide():$(".comment-submit, .comment-body").show(),$("input[name=auth_provider]").val(e),!1})}),$.blog_utils={query:"",init:function(){if(-1!==location.href.indexOf("?"))for(var e=location.href.indexOf("?"),t=location.href.slice(e+1).split("&"),i=0;i<t.length;i+=1)if(-1!==t[i].indexOf("query=")){this.query=t[i].slice(t[i].indexOf("query=")+6);break}},highlight:function(e){this.query&&$(e).find(".search-match").find("h3 a, p").each(function(){var e=$(this).html();e=e.replace(new RegExp("("+$.blog_utils.query+")","i"),'<span class="highlighted">$1</span>'),$(this).html(e)})}},$.blog_utils.init();